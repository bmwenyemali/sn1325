import connectDB from "../lib/mongodb";
import { Axe, Province } from "../models/Referentiel";
import { User, Role, Privilege } from "../models/User";
import { SimpleData } from "../models/SimpleData";

export async function initializeRealData() {
  try {
    await connectDB();
    console.log("üîå Connexion √† MongoDB √©tablie");

    // Supprimer les donn√©es existantes
    await Promise.all([
      Axe.deleteMany({}),
      Province.deleteMany({}),
      User.deleteMany({}),
      Role.deleteMany({}),
      Privilege.deleteMany({}),
      SimpleData.deleteMany({}),
    ]);
    console.log("üóëÔ∏è Donn√©es existantes supprim√©es");

    // 1. Cr√©er les 5 axes strat√©giques
    const axes = await Axe.insertMany([
      {
        code: "PART",
        nom: "Participation",
        description:
          "Participation accrue des femmes aux processus de prise de d√©cision et aux n√©gociations de paix",
        couleur: "#002B7F",
        ordre: 1,
        statut: "actif",
        dateCreation: new Date(),
        dateModification: new Date(),
      },
      {
        code: "PROT",
        nom: "Protection",
        description:
          "Protection des droits des femmes et des filles en p√©riode de conflit et post-conflit",
        couleur: "#FCD116",
        ordre: 2,
        statut: "actif",
        dateCreation: new Date(),
        dateModification: new Date(),
      },
      {
        code: "PREV",
        nom: "Pr√©vention",
        description:
          "Pr√©vention des conflits et des violences bas√©es sur le genre",
        couleur: "#CE1126",
        ordre: 3,
        statut: "actif",
        dateCreation: new Date(),
        dateModification: new Date(),
      },
      {
        code: "RELV",
        nom: "Rel√®vement",
        description: "Rel√®vement et reconstruction tenant compte du genre",
        couleur: "#28A745",
        ordre: 4,
        statut: "actif",
        dateCreation: new Date(),
        dateModification: new Date(),
      },
      {
        code: "COORD",
        nom: "Coordination",
        description: "Coordination et mise en ≈ìuvre de la r√©solution 1325",
        couleur: "#6F42C1",
        ordre: 5,
        statut: "actif",
        dateCreation: new Date(),
        dateModification: new Date(),
      },
    ]);
    console.log("‚úÖ Axes strat√©giques cr√©√©s:", axes.length);

    // 2. Cr√©er les 26 provinces de la RDC
    const provinces = await Province.insertMany([
      { nom: "Kinshasa", code: "KIN", region: "Kinshasa", statut: "actif" },
      { nom: "Bas-U√©l√©", code: "BU", region: "Orientale", statut: "actif" },
      { nom: "√âquateur", code: "EQ", region: "√âquateur", statut: "actif" },
      { nom: "Haut-Katanga", code: "HK", region: "Katanga", statut: "actif" },
      { nom: "Haut-Lomami", code: "HL", region: "Katanga", statut: "actif" },
      { nom: "Haut-U√©l√©", code: "HU", region: "Orientale", statut: "actif" },
      { nom: "Ituri", code: "IT", region: "Orientale", statut: "actif" },
      { nom: "Kasa√Ø", code: "KS", region: "Kasa√Ø", statut: "actif" },
      { nom: "Kasa√Ø-Central", code: "KC", region: "Kasa√Ø", statut: "actif" },
      { nom: "Kasa√Ø-Oriental", code: "KO", region: "Kasa√Ø", statut: "actif" },
      {
        nom: "Kongo-Central",
        code: "KgC",
        region: "Kongo-Central",
        statut: "actif",
      },
      { nom: "Kwango", code: "KW", region: "Kwango", statut: "actif" },
      { nom: "Kwilu", code: "KL", region: "Kwilu", statut: "actif" },
      { nom: "Lomami", code: "LM", region: "Katanga", statut: "actif" },
      { nom: "Lualaba", code: "LU", region: "Katanga", statut: "actif" },
      { nom: "Mai-Ndombe", code: "MN", region: "Mai-Ndombe", statut: "actif" },
      { nom: "Maniema", code: "MA", region: "Maniema", statut: "actif" },
      { nom: "Mongala", code: "MO", region: "√âquateur", statut: "actif" },
      { nom: "Nord-Kivu", code: "NK", region: "Nord-Kivu", statut: "actif" },
      { nom: "Nord-Ubangi", code: "NU", region: "√âquateur", statut: "actif" },
      { nom: "Sankuru", code: "SA", region: "Kasa√Ø", statut: "actif" },
      { nom: "Sud-Kivu", code: "SK", region: "Sud-Kivu", statut: "actif" },
      { nom: "Sud-Ubangi", code: "SU", region: "√âquateur", statut: "actif" },
      { nom: "Tanganyika", code: "TA", region: "Katanga", statut: "actif" },
      { nom: "Tshopo", code: "TS", region: "Orientale", statut: "actif" },
      { nom: "Tshuapa", code: "TSH", region: "√âquateur", statut: "actif" },
    ]);
    console.log("‚úÖ Provinces cr√©√©es:", provinces.length);

    // 3. Cr√©er r√¥les et privil√®ges pour l'admin
    // Cr√©er tous les privil√®ges n√©cessaires
    const privileges = await Privilege.insertMany([
      {
        nom: "Lecture",
        code: "READ",
        description: "Lecture des donn√©es",
        module: "all",
        action: "read",
      },
      {
        nom: "√âcriture",
        code: "WRITE",
        description: "Cr√©ation et modification",
        module: "all",
        action: "create",
      },
      {
        nom: "Suppression",
        code: "DELETE",
        description: "Suppression des donn√©es",
        module: "all",
        action: "delete",
      },
      {
        nom: "Administration",
        code: "ADMIN",
        description: "Administration compl√®te",
        module: "all",
        action: "publish",
      },
    ]);
    console.log("‚úÖ Privil√®ges cr√©√©s:", privileges.length);

    // Cr√©er le r√¥le Admin
    const adminRole = await Role.create({
      nom: "Administrateur",
      code: "ADMIN",
      description: "Administrateur syst√®me avec tous les droits",
      niveau: 1,
      privileges: privileges.map((p) => p._id),
      active: true,
    });
    console.log("‚úÖ R√¥le Admin cr√©√©");

    // Cr√©er le r√¥le Consultant
    const consultantRole = await Role.create({
      nom: "Consultant",
      code: "CONSULTANT",
      description: "Consultant avec acc√®s en lecture et saisie de donn√©es",
      niveau: 3,
      privileges: privileges
        .filter((p) => ["READ", "WRITE"].includes(p.code))
        .map((p) => p._id),
      active: true,
    });
    console.log("‚úÖ R√¥le Consultant cr√©√©");

    // Cr√©er l'utilisateur administrateur par d√©faut
    const adminUser = await User.create({
      nom: "Admin",
      prenom: "Syst√®me",
      email: "admin@sn1325.cd",
      password: "admin123",
      role: adminRole._id,
      privileges: privileges.map((p) => p._id),
      province: provinces.find((p) => p.nom === "Kinshasa")?._id,
      fonction: "Administrateur Syst√®me",
      organisation: "Secr√©tariat National 1325",
      statut: "actif",
    });
    console.log("‚úÖ Utilisateur admin cr√©√©:", adminUser.email);

    // Cr√©er l'utilisateur consultant par d√©faut
    const consultantUser = await User.create({
      nom: "Mukendi",
      prenom: "Consultant",
      email: "consultant@sn1325.cd",
      password: "consult123",
      role: consultantRole._id,
      privileges: privileges
        .filter((p) => ["READ", "WRITE"].includes(p.code))
        .map((p) => p._id),
      province: provinces.find((p) => p.nom === "Nord-Kivu")?._id,
      fonction: "Consultant Technique",
      organisation: "ONU Femmes",
      statut: "actif",
    });
    console.log("‚úÖ Utilisateur consultant cr√©√©:", consultantUser.email);

    // 4. Injecter quelques donn√©es r√©elles bas√©es sur les rapports 2022 et 2025
    const participationAxe = axes.find((a) => a.nom === "Participation");
    const protectionAxe = axes.find((a) => a.nom === "Protection");
    const preventionAxe = axes.find((a) => a.nom === "Pr√©vention");
    const kinshasa = provinces.find((p) => p.nom === "Kinshasa");
    const nordKivu = provinces.find((p) => p.nom === "Nord-Kivu");
    const sudKivu = provinces.find((p) => p.nom === "Sud-Kivu");

    const sampleData = await SimpleData.insertMany([
      // Donn√©es Participation 2022
      {
        axeId: participationAxe?._id,
        indicateurId: null, // Sera cr√©√© plus tard
        provinceId: kinshasa?._id,
        annee: 2022,
        trimestre: "T4",
        valeurNumerique: 13.6,
        uniteMesure: "%",
        description: "Pourcentage de femmes √† l'Assembl√©e Nationale",
        commentaire: "Donn√©es du rapport parlementaire 2022",
        statut: "valide",
        source: "Assembl√©e Nationale RDC",
        dateCreation: new Date(),
        dateModification: new Date(),
        createdBy: adminUser._id,
      },
      {
        axeId: participationAxe?._id,
        provinceId: kinshasa?._id,
        annee: 2022,
        trimestre: "T4",
        valeurNumerique: 8.2,
        uniteMesure: "%",
        description: "Pourcentage de femmes au S√©nat",
        commentaire: "Donn√©es officielles du S√©nat",
        statut: "valide",
        source: "S√©nat RDC",
        dateCreation: new Date(),
        dateModification: new Date(),
        createdBy: adminUser._id,
      },
      // Donn√©es Protection 2022
      {
        axeId: protectionAxe?._id,
        provinceId: nordKivu?._id,
        annee: 2022,
        trimestre: "T4",
        valeurNumerique: 2847,
        uniteMesure: "cas",
        description: "Cas de violences bas√©es sur le genre signal√©s",
        commentaire: "Donn√©es UNFPA Nord-Kivu",
        statut: "valide",
        source: "UNFPA",
        dateCreation: new Date(),
        dateModification: new Date(),
        createdBy: adminUser._id,
      },
      {
        axeId: protectionAxe?._id,
        provinceId: sudKivu?._id,
        annee: 2022,
        trimestre: "T4",
        valeurNumerique: 1923,
        uniteMesure: "cas",
        description: "Cas de violences bas√©es sur le genre signal√©s",
        commentaire: "Donn√©es UNFPA Sud-Kivu",
        statut: "valide",
        source: "UNFPA",
        dateCreation: new Date(),
        dateModification: new Date(),
        createdBy: adminUser._id,
      },
      // Donn√©es Pr√©vention 2022
      {
        axeId: preventionAxe?._id,
        provinceId: nordKivu?._id,
        annee: 2022,
        trimestre: "T4",
        valeurNumerique: 42,
        uniteMesure: "comit√©s",
        description: "Comit√©s de paix avec participation f√©minine active",
        commentaire: "M√©canismes d'alerte pr√©coce op√©rationnels",
        statut: "valide",
        source: "MONUSCO",
        dateCreation: new Date(),
        dateModification: new Date(),
        createdBy: adminUser._id,
      },
      // Donn√©es 2025 (projections/objectifs)
      {
        axeId: participationAxe?._id,
        provinceId: kinshasa?._id,
        annee: 2025,
        trimestre: "T1",
        valeurNumerique: 18.5,
        uniteMesure: "%",
        description: "Objectif femmes √† l'Assembl√©e Nationale",
        commentaire: "Objectif Plan d'Action National 2025",
        statut: "planifie",
        source: "Plan d'Action National 1325",
        dateCreation: new Date(),
        dateModification: new Date(),
        createdBy: adminUser._id,
      },
      {
        axeId: protectionAxe?._id,
        provinceId: nordKivu?._id,
        annee: 2025,
        trimestre: "T1",
        valeurTexte:
          "Am√©lioration significative de l'acc√®s √† la justice pour les femmes victimes de violences",
        uniteMesure: "√©valuation qualitative",
        description: "√âvaluation de l'acc√®s √† la justice",
        commentaire: "Objectif strat√©gique pour 2025",
        statut: "planifie",
        source: "Minist√®re de la Justice",
        dateCreation: new Date(),
        dateModification: new Date(),
        createdBy: adminUser._id,
      },
    ]);
    console.log("‚úÖ Donn√©es r√©elles inject√©es:", sampleData.length);

    console.log("\nüéâ Initialisation compl√®te r√©ussie !");
    console.log("üìä R√©sum√©:");
    console.log(`   - ${axes.length} axes strat√©giques`);
    console.log(`   - ${provinces.length} provinces`);
    console.log(`   - 2 utilisateurs (admin + consultant)`);
    console.log(`   - ${sampleData.length} entr√©es de donn√©es`);
    console.log("\nüîë Comptes de connexion:");
    console.log("   Admin: admin@sn1325.cd / admin123");
    console.log("   Consultant: consultant@sn1325.cd / consult123");

    return {
      success: true,
      summary: {
        axes: axes.length,
        provinces: provinces.length,
        users: 2,
        dataEntries: sampleData.length,
      },
    };
  } catch (error) {
    console.error("‚ùå Erreur lors de l'initialisation:", error);
    throw error;
  }
}

// Ex√©cuter le script si appel√© directement
if (require.main === module) {
  initializeRealData()
    .then(() => {
      console.log("‚úÖ Script termin√© avec succ√®s");
      process.exit(0);
    })
    .catch((error) => {
      console.error("‚ùå Erreur fatale:", error);
      process.exit(1);
    });
}
